<!DOCTYPE html>
<html data-theme="light">

<head>
    <script>
        // 在页面渲染前就设置主题
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'system') {
                // 跟随系统设置
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            } else if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else {
                // 默认跟随系统
                localStorage.setItem('theme', 'system');
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            }
        })();
    </script>
    <title>智能二维码工具箱 - 管理面板</title>
    <meta charset="UTF-8">
    <meta name="darkreader-lock">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="/daisyui@5.css" rel="stylesheet" type="text/css" />
    <script src="/tailwindcss@4.js"></script>
    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-warning: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 15px 35px rgba(0, 0, 0, 0.15);
            --shadow-strong: 0 20px 40px rgba(0, 0, 0, 0.2);
            --border-radius: 16px;
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        #qr-container canvas {
            transition: var(--transition-smooth);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
        }

        #qr-container.switching canvas {
            opacity: 0;
            transform: scale(0.95);
        }

        /* 现代化卡片样式 */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            transition: var(--transition-smooth);
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* 现代化按钮样式 */
        .btn {
            border-radius: 12px;
            font-weight: 600;
            transition: var(--transition-smooth);
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
        }

        /* 表格样式优化 */
        .table-responsive {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }

        .table-responsive table {
            table-layout: fixed;
            width: 100%;
        }

        .table-responsive td, .table-responsive th {
            vertical-align: top;
            word-break: break-word;
            padding: 1rem 0.75rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .table-responsive th {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            font-weight: 600;
            color: #475569;
        }

        .table-responsive tbody tr {
            transition: var(--transition-smooth);
        }

        .table-responsive tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
            transform: scale(1.01);
        }

        /* 调整各列宽度 */
        .table-responsive th:nth-child(1), .table-responsive td:nth-child(1) { width: 15%; }
        .table-responsive th:nth-child(2), .table-responsive td:nth-child(2) { width: 12%; }
        .table-responsive th:nth-child(3), .table-responsive td:nth-child(3) {
            width: 28%;
            white-space: normal;
            overflow-wrap: break-word;
        }
        .table-responsive th:nth-child(4), .table-responsive td:nth-child(4) { width: 12%; }
        .table-responsive th:nth-child(5), .table-responsive td:nth-child(5) { width: 13%; }
        .table-responsive th:nth-child(6), .table-responsive td:nth-child(6) { width: 20%; }

        /* 编辑模式下的行样式 */
        .table-responsive tr.editing {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            box-shadow: inset 0 0 0 2px rgba(99, 102, 241, 0.3);
        }

        .table-responsive tr.editing td {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        /* 移动端响应式样式 */
        /* 现代化输入框样式 */
        .input, .select, .textarea {
            border-radius: 12px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            transition: var(--transition-smooth);
            font-weight: 500;
        }

        .input:focus, .select:focus, .textarea:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }

        /* 浮动标签效果 */
        .floating-label {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .floating-label input, .floating-label select, .floating-label textarea {
            width: 100%;
            padding: 1rem 1rem 0.5rem 1rem;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            transition: var(--transition-smooth);
        }

        .floating-label label {
            position: absolute;
            left: 1rem;
            top: 1rem;
            color: #6b7280;
            font-size: 1rem;
            transition: var(--transition-smooth);
            pointer-events: none;
            background: transparent;
        }

        .floating-label input:focus + label,
        .floating-label input:not(:placeholder-shown) + label,
        .floating-label select:focus + label,
        .floating-label textarea:focus + label,
        .floating-label textarea:not(:placeholder-shown) + label {
            top: 0.25rem;
            font-size: 0.75rem;
            color: #6366f1;
            font-weight: 600;
        }

        .floating-label input:focus,
        .floating-label select:focus,
        .floating-label textarea:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        /* 现代化导航栏 */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            margin-bottom: 2rem;
        }

        .navbar h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            font-size: 1.75rem;
        }

        /* 上传区域样式 */
        #qr-upload-area {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px dashed #6366f1;
            border-radius: var(--border-radius);
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        #qr-upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(99, 102, 241, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        #qr-upload-area:hover::before {
            transform: translateX(100%);
        }

        #qr-upload-area:hover {
            border-color: #4f46e5;
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* 加载动画 */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% { transform: translateY(0); }
            40%, 43% { transform: translateY(-10px); }
            70% { transform: translateY(-5px); }
            90% { transform: translateY(-2px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        .slide-up {
            animation: slideUp 0.4s ease-out;
        }

        .scale-in {
            animation: scaleIn 0.3s ease-out;
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        .bounce-animation {
            animation: bounce 1s;
        }

        .shake-animation {
            animation: shake 0.5s;
        }

        /* 悬停效果增强 */
        .hover-lift {
            transition: var(--transition-smooth);
        }

        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-medium);
        }

        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }

        /* 点击效果 */
        .click-effect {
            position: relative;
            overflow: hidden;
        }

        .click-effect::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .click-effect:active::after {
            width: 300px;
            height: 300px;
        }

        /* 现代化模态框 */
        .modal-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-strong);
        }

        /* 现代化徽章 */
        .badge {
            border-radius: 8px;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
        }

        /* 平板设备优化 */
        @media (max-width: 1024px) {
            .grid-cols-1.lg\\:grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .flex.lg\\:flex-row {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            body {
                padding: 0 8px;
                margin: 8px auto;
            }

            .card-body {
                padding: 1rem;
            }

            .navbar {
                margin-bottom: 1rem;
                padding: 0.75rem 1rem;
            }

            .navbar h1 {
                font-size: 1.25rem;
            }

            .navbar .flex.gap-3 {
                gap: 0.5rem;
            }

            /* 优化卡片间距 */
            .card.mb-8 {
                margin-bottom: 1.5rem;
            }

            /* 优化表单布局 */
            .floating-label {
                margin-bottom: 1rem;
            }

            .floating-label input,
            .floating-label select,
            .floating-label textarea {
                padding: 0.875rem 0.875rem 0.375rem 0.875rem;
                font-size: 0.875rem;
            }

            .floating-label label {
                left: 0.875rem;
                top: 0.875rem;
                font-size: 0.875rem;
            }

            .floating-label input:focus + label,
            .floating-label input:not(:placeholder-shown) + label,
            .floating-label select:focus + label,
            .floating-label textarea:focus + label,
            .floating-label textarea:not(:placeholder-shown) + label {
                top: 0.125rem;
                font-size: 0.625rem;
            }

            /* 优化按钮组 */
            .flex.flex-wrap.gap-2 {
                justify-content: center;
                gap: 0.5rem;
            }

            .btn-sm {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }

            /* 表格响应式处理 */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                position: relative;
                margin: 0 -1rem; /* 抵消卡片内边距 */
                padding: 0 1rem;
                width: calc(100% + 2rem);
            }

            /* 表格基础样式调整 */
            .table-responsive table {
                min-width: 800px; /* 确保在小屏幕上可以横向滚动 */
                font-size: 0.875rem; /* 稍微减小字体大小 */
            }

            /* 调整单元格内边距 */
            .table-responsive td,
            .table-responsive th {
                padding: 0.5rem;
                white-space: normal;
                line-height: 1.4;
            }

            /* 优化各列宽度 */
            .table-responsive th:nth-child(1), /* 条目名称 */
            .table-responsive td:nth-child(1) {
                min-width: 120px;
                max-width: 150px;
            }

            .table-responsive th:nth-child(2), /* 短链名 */
            .table-responsive td:nth-child(2) {
                min-width: 100px;
                max-width: 120px;
            }

            .table-responsive th:nth-child(3), /* 目标URL */
            .table-responsive td:nth-child(3) {
                min-width: 200px;
                max-width: 300px;
            }

            .table-responsive th:nth-child(4), /* 有效日期 */
            .table-responsive td:nth-child(4) {
                min-width: 100px;
                max-width: 120px;
            }

            .table-responsive th:nth-child(5), /* 状态 */
            .table-responsive td:nth-child(5) {
                min-width: 100px;
                max-width: 120px;
            }

            .table-responsive th:nth-child(6), /* 操作 */
            .table-responsive td:nth-child(6) {
                min-width: 150px;
                position: sticky;
                right: 0;
                background: var(--b1);
                box-shadow: -4px 0 6px -2px rgba(0, 0, 0, 0.1);
            }

            /* 编辑模式下的样式优化 */
            .table-responsive tr.editing td {
                padding: 0.75rem 0.5rem;
            }

            .table-responsive tr.editing input,
            .table-responsive tr.editing textarea {
                font-size: 0.875rem;
                padding: 0.25rem 0.5rem;
            }

            /* 添加横向滚动提示 */
            .table-responsive::after {
                content: '';
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                width: 30px;
                background: linear-gradient(to right, transparent, rgba(var(--b1), 0.1));
                pointer-events: none;
            }

            /* 优化操作按钮组 */
            .table-responsive .join {
                flex-wrap: nowrap;
                gap: 0.25rem;
            }

            .table-responsive .join .btn {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
        }

        /* 添加滚动条样式美化 */
        .table-responsive::-webkit-scrollbar {
            height: 6px;
        }

        .table-responsive::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .table-responsive::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 3px;
        }

        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            body {
                padding: 0 4px;
                margin: 4px auto;
            }

            .navbar {
                padding: 0.5rem;
                margin-bottom: 0.75rem;
            }

            .navbar h1 {
                font-size: 1rem;
            }

            .navbar .w-10.h-10 {
                width: 2rem;
                height: 2rem;
            }

            .navbar .w-6.h-6 {
                width: 1rem;
                height: 1rem;
            }

            .card-body {
                padding: 0.75rem;
            }

            .btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }

            .btn.h-12 {
                height: 2.5rem;
                font-size: 0.875rem;
            }

            .floating-label input,
            .floating-label select,
            .floating-label textarea {
                padding: 0.75rem;
                font-size: 0.8rem;
            }

            .floating-label label {
                left: 0.75rem;
                top: 0.75rem;
                font-size: 0.8rem;
            }

            .floating-label input:focus + label,
            .floating-label input:not(:placeholder-shown) + label,
            .floating-label select:focus + label,
            .floating-label textarea:focus + label,
            .floating-label textarea:not(:placeholder-shown) + label {
                top: 0.125rem;
                font-size: 0.6rem;
            }

            /* 优化分页器 */
            .flex.lg\\:flex-row.justify-between {
                flex-direction: column;
                gap: 1rem;
            }

            .flex.items-center.gap-2 .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }
        }

        /* 优化表格过渡效果 */
        .table-responsive tbody {
            transition: none;
        }

        .table-responsive.loading tbody {
            opacity: 1;
        }

        /* 添加表格容器过渡效果 */
        .table-responsive {
            position: relative;
            min-height: 100px;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }

        #loading.visible {
            opacity: 1;
        }
    </style>
</head>

<body>
    <!-- 添加模态对话框 HTML 在 body 开始处 -->
    <dialog id="qr-modal" class="modal">
        <div class="modal-box">
            <form method="dialog">
                <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
            </form>
            <h3 class="font-bold text-lg mb-4">二维码</h3>
            <div id="qr-container" class="flex justify-center mb-4"></div>
            <div class="mb-4">
                <label class="floating-label">
                    <span class="label-text text-primary">链接地址</span>
                </label>
                <input type="text" id="qr-url" class="input input-ghost w-full" readonly>
            </div>
            <div class="modal-action gap-4">
                <label class="label cursor-pointer gap-2">
                    <input type="checkbox" id="qr-show-logo" class="checkbox checkbox-primary" checked>
                    <span class="label-text">显示微信图标</span>
                </label>

                <select id="qr-dots-style" class="select select-bordered">
                    <option value="dots" selected>圆点</option>
                    <option value="rounded">圆角</option>
                    <option value="classy">优雅</option>
                    <option value="classy-rounded">优雅圆角</option>
                    <option value="square">方形</option>
                    <option value="extra-rounded">超圆角</option>
                </select>

                <button id="qr-download" class="btn btn-info">下载二维码</button>
                <button class="btn btn-primary" onclick="document.getElementById('qr-modal').close()">关闭</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>关闭</button>
        </form>
    </dialog>

    <!-- 在 body 开始处添加删除确认模态框 -->
    <dialog id="delete-confirm-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">确认删除</h3>
            <p class="py-4">确定要删除这个短链吗？此操作不可撤销。</p>
            <div class="modal-action">
                <form method="dialog" class="join">
                    <button id="confirm-delete-btn" class="join-item btn btn-error">确认删除</button>
                    <button class="join-item btn btn-primary">取消</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>关闭</button>
        </form>
    </dialog>

    <div id="alertContainer" class="fixed left-1/2 transform -translate-x-1/2 z-50"></div>
    <input type="hidden" id="qrCodeData">
    <div class="navbar fade-in">
        <div class="flex-1 justify-center md:justify-start">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h4M4 4h4m0 0V2m0 2h4m0 0V2m0 2v2M4 4v16h16V4H4z" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold">智能二维码工具箱</h1>
            </div>
        </div>
        <div class="flex gap-3 justify-center md:justify-end">
            <div class="tooltip tooltip-bottom" data-tip="切换主题">
                <button id="themeToggleBtn" class="btn btn-ghost btn-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
            </div>
            <div class="tooltip tooltip-bottom" data-tip="退出登录">
                <button id="logoutBtn" class="btn btn-error btn-sm gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    <span class="hidden md:inline">退出登录</span>
                </button>
            </div>
        </div>
    </div>

    <div class="card fade-in hover-lift mb-8">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
                <h2 class="text-xl font-bold">使用说明</h2>
            </div>
            <div class="join join-vertical w-full">
                <div class="collapse collapse-arrow join-item border border-base-300">
                    <input type="radio" name="my-accordion-4" checked="checked" />
                    <div class="collapse-title text-lg font-bold">
                        使用步骤
                    </div>
                    <div class="collapse-content">
                        <ul class="list-disc list-inside space-y-1">
                            <li>1.将群聊二维码拖动或点击上传到二维码识别区域，即可自动识别二维码，并自动填充到目标URL输入框</li>
                            <li>2.在目标URL输入框中输入群聊的名称、短链的名称，选择过期时间或者不设置过期时间，点击添加短链二维码</li>
                            <li>3.在下方管理面板中可以看到已经添加的短链二维码，可以编辑、删除已创建的短链，并可查看或下载对应二维码</li>
                        </ul>
                    </div>
                </div>
                <div class="collapse collapse-arrow join-item border border-base-300">
                    <input type="radio" name="my-accordion-4" />
                    <div class="collapse-title text-lg font-bold">
                        注意事项
                    </div>
                    <div class="collapse-content">
                        <ul class="list-disc list-inside space-y-1">
                            <li>1.短链名只能包含字母、数字、下划线和横线</li>
                            <li>2.可以设置短链的过期时间，不设置则永久有效</li>
                            <li>3.如果过期会自动通过邮件通知</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card fade-in mb-8">
        <div class="card-body">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-green-500 to-blue-600 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h4M4 4h4m0 0V2m0 2h4m0 0V2m0 2v2M4 4v16h16V4H4z" />
                    </svg>
                </div>
                <h2 class="text-xl font-bold">二维码识别与短链创建</h2>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- 左侧：二维码识别区域 -->
                <div class="space-y-4">
                    <div id="qr-upload-area" class="p-8 text-center cursor-pointer relative">
                        <div class="flex flex-col items-center gap-4">
                            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-lg font-semibold text-gray-700">点击上传或拖拽二维码图片</p>
                                <p class="text-sm text-gray-500 mt-1">支持 PNG、JPG、JPEG 格式</p>
                            </div>
                        </div>
                        <input type="file" id="qr-file" accept="image/*" class="hidden">
                    </div>
                    <div id="qr-result" class="card hidden">
                        <div class="card-body">
                            <h3 class="font-bold text-lg flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                识别成功
                            </h3>
                            <p class="text-sm text-gray-600 mb-2">已自动填充到右侧表单</p>
                            <p id="decoded-text" class="font-mono text-sm bg-gray-100 p-3 rounded-lg break-all"></p>
                            <div class="card-actions justify-end mt-4">
                                <button id="copy-btn" class="btn btn-success btn-sm gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    复制链接
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 右侧：短链创建表单 -->
                <div class="card p-6">
                    <div class="space-y-6">
                        <div class="floating-label">
                            <input type="text" id="newName" placeholder=" " class="w-full">
                            <label for="newName">条目名称 (例: 音乐群1)</label>
                        </div>

                        <div class="floating-label">
                            <input type="text" id="newPath" placeholder=" " class="w-full">
                            <label for="newPath">短链名 (例: music1)</label>
                        </div>

                        <div class="floating-label">
                            <input type="text" id="newTarget" placeholder=" " class="w-full">
                            <label for="newTarget">目标URL (例: https://x.com/xxx)</label>
                        </div>

                        <div class="floating-label">
                            <input type="date" id="newExpiry" placeholder=" " class="w-full">
                            <label for="newExpiry">有效日期 (可选)</label>
                        </div>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">启用该短链</p>
                                        <p class="text-sm text-gray-500">禁用后访问短链将返回404</p>
                                    </div>
                                </div>
                                <input type="checkbox" id="newEnabled" class="toggle toggle-primary" checked>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-blue-50 rounded-xl">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">微信二维码</p>
                                        <p class="text-sm text-gray-500">使用活码页面展示原二维码</p>
                                    </div>
                                </div>
                                <input type="checkbox" id="newIsWechat" class="toggle toggle-primary">
                            </div>
                        </div>

                        <button id="addMappingBtn" class="btn btn-primary w-full h-12 text-lg font-semibold gap-3 click-effect hover-glow">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            添加短链二维码
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card fade-in">
        <div class="card-body">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold">短链二维码管理</h2>
                </div>

                <div class="flex flex-wrap gap-2">
                    <button id="showAllBtn" class="btn btn-sm gap-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white border-none click-effect hover-lift">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                        </svg>
                        全部
                    </button>
                    <button id="showExpiringBtn" class="btn btn-sm gap-2 bg-gradient-to-r from-yellow-500 to-orange-500 text-white border-none click-effect hover-lift">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        即将过期
                    </button>
                    <button id="showExpiredBtn" class="btn btn-sm gap-2 bg-gradient-to-r from-red-500 to-red-600 text-white border-none click-effect hover-lift">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        已过期
                    </button>
                </div>
            </div>

            <div id="loading" class="flex flex-col items-center justify-center py-12 hidden">
                <div class="loading-spinner mb-4"></div>
                <p class="text-gray-500 font-medium">加载中...</p>
            </div>

            <div class="overflow-x-auto table-responsive">
                <!-- 现代化骨架屏 -->
                <div id="skeleton" class="hidden space-y-4">
                    <div class="animate-pulse">
                        <div class="h-6 bg-gray-200 rounded-lg w-32 mb-6"></div>
                        <div class="space-y-3">
                            <div class="grid grid-cols-5 gap-4">
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                            </div>
                            <div class="grid grid-cols-5 gap-4">
                                <div class="h-4 bg-gray-100 rounded"></div>
                                <div class="h-4 bg-gray-100 rounded"></div>
                                <div class="h-4 bg-gray-100 rounded"></div>
                                <div class="h-4 bg-gray-100 rounded"></div>
                                <div class="h-4 bg-gray-100 rounded"></div>
                            </div>
                            <div class="grid grid-cols-5 gap-4">
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                                <div class="h-4 bg-gray-200 rounded"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th class="w-[15%]">条目名称</th>
                            <th class="w-[12%]">短链名</th>
                            <th class="w-[28%]">目标 URL</th>
                            <th class="w-[15%]">有效日期</th>
                            <th class="w-[30%]">状态</th>
                        </tr>
                    </thead>
                    <tbody id="mappingsTableBody">
                    </tbody>
                </table>
            </div>
            <div class="flex flex-col lg:flex-row justify-between items-center mt-8 gap-6 p-4 bg-gray-50 rounded-xl">
                <div class="flex items-center gap-3">
                    <span class="text-sm font-medium text-gray-600">每页显示:</span>
                    <select id="pageSize" class="select select-bordered select-sm bg-white">
                        <option value="10">10 条</option>
                        <option value="20">20 条</option>
                        <option value="50">50 条</option>
                    </select>
                </div>

                <div class="flex items-center gap-2">
                    <button id="prevPage" class="btn btn-sm gap-2 bg-white border-gray-200 hover:bg-gray-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        上一页
                    </button>

                    <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg border border-gray-200">
                        <span class="text-sm text-gray-600">第</span>
                        <span id="currentPage" class="font-bold text-blue-600">1</span>
                        <span class="text-sm text-gray-600">页</span>
                    </div>

                    <button id="nextPage" class="btn btn-sm gap-2 bg-white border-gray-200 hover:bg-gray-50">
                        下一页
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-8 mb-4 bg-base-200/80 backdrop-blur py-4">
        <div class="footer-links" style="margin: 20px 0 10px 0; text-align: center;">
            <a href="https://tv.zymn.cc" target="_blank" style="margin: 0 12px; color: #bdbdbd; text-decoration: none; font-weight: 500;">免费电影</a>
            <a href="https://sl.zymn.cc" target="_blank" style="margin: 0 12px; color: #bdbdbd; text-decoration: none; font-weight: 500;">短链生成器</a>
            <a href="https://yhjf.zymn.cc" target="_blank" style="margin: 0 12px; color: #bdbdbd; text-decoration: none; font-weight: 500;">隐秘信使</a>
        </div>
        <div class="footer-content" style="text-align: center; color: #bdbdbd;">
            <a href="https://www.youtube.com/channel/UCn0Yarp_h6oqn1-QLvlgbDg?sub_confirmation=1" target="_blank" rel="nofollow noopener"><span>Youtube</span></a>- <a href="https://twitter.com/spatacus1986" target="_blank" rel="nofollow noopener"><span>Twitter</span></a>- <a href="https://t.me/+8W45Y29o5T1mMGI1" target="_blank" rel="nofollow noopener"><span>电报群</span></a>- <a href="https://v.douyin.com/iNpPYY4E/" target="_blank" rel="nofollow noopener"><span>抖音</span></a>- <a href="https://www.ixigua.com/home/103680436540" target="_blank" rel="nofollow noopener"><span>西瓜视频</span></a>
        </div>
    </footer>

    <script type="text/javascript" src="/qr-code-styling.js"></script>
    <script src="/zxing.js"></script>
    <script>
        const banPath = [
            'login', 'admin', '__total_count',
            // static files
            'admin.html', 'login.html',
            'daisyui@5.css', 'tailwindcss@4.js',
            'qr-code-styling.js', 'zxing.js',
            'robots.txt', 'wechat.svg',
            'favicon.svg',
        ];
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 添加初始认证检查
            checkAuth().then(isAuthenticated => {
                if (!isAuthenticated) {
                    window.location.href = '/login';
                    return;
                }
                // 初始化页面
                initializePage();
            });

            // 认证检查函数
            async function checkAuth() {
                try {
                    const response = await fetch('/api/mappings');
                    if (response.status === 401) {
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error('认证检查失败:', error);
                    return false;
                }
            }

            // 页面初始化函数
            function initializePage() {
                // 将原有的初始化代码移到这里
                document.getElementById('logoutBtn').addEventListener('click', logout);
                document.getElementById('addMappingBtn').addEventListener('click', addMapping);
                setupQRUpload();

                // 添加主题切换功能
                const themeToggleBtn = document.getElementById('themeToggleBtn');
                themeToggleBtn.addEventListener('click', toggleTheme);

                // 加载短链二维码数据
                loadMappings();

                // 添加全局错误处理
                setupErrorHandling();

                // 添加筛选按钮状态管理
                const filterButtons = {
                    showAllBtn: { element: document.getElementById('showAllBtn'), class: 'btn-primary' },
                    showExpiringBtn: { element: document.getElementById('showExpiringBtn'), class: 'btn-warning' },
                    showExpiredBtn: { element: document.getElementById('showExpiredBtn'), class: 'btn-error' }
                };

                function updateFilterButtonStates(activeButtonId) {
                    Object.entries(filterButtons).forEach(([id, { element, class: buttonClass }]) => {
                        if (id === activeButtonId) {
                            element.classList.add(buttonClass);
                        } else {
                            element.classList.remove(buttonClass);
                        }
                    });
                }

                // 修改筛选按钮的点击事件
                document.getElementById('showAllBtn').addEventListener('click', async () => {
                    currentPage = 1; // 重置页码
                    const btn = document.getElementById('showAllBtn');
                    const expiringBtn = document.getElementById('showExpiringBtn');
                    const expiredBtn = document.getElementById('showExpiredBtn');
                    
                    btn.classList.add('btn-primary');
                    expiringBtn.classList.remove('btn-warning');
                    expiredBtn.classList.remove('btn-error');
                    
                    await loadMappings();
                });

                document.getElementById('showExpiringBtn').addEventListener('click', async () => {
                    currentPage = 1; // 重置页码
                    const btn = document.getElementById('showExpiringBtn');
                    const allBtn = document.getElementById('showAllBtn');
                    const expiredBtn = document.getElementById('showExpiredBtn');
                    
                    btn.classList.add('btn-warning');
                    allBtn.classList.remove('btn-primary');
                    expiredBtn.classList.remove('btn-error');
                    
                    await loadExpiringMappings('expiring');
                });

                document.getElementById('showExpiredBtn').addEventListener('click', async () => {
                    currentPage = 1; // 重置页码
                    const btn = document.getElementById('showExpiredBtn');
                    const allBtn = document.getElementById('showAllBtn');
                    const expiringBtn = document.getElementById('showExpiringBtn');
                    
                    btn.classList.add('btn-error');
                    allBtn.classList.remove('btn-primary');
                    expiringBtn.classList.remove('btn-warning');
                    
                    await loadExpiringMappings('expired');
                });

                // 添加微信二维码开关事件监听
                document.getElementById('newIsWechat').addEventListener('change', function(e) {
                    const targetInput = document.getElementById('newTarget');
                    const decodedText = document.getElementById('decoded-text').textContent;
                    
                    if (e.target.checked) {
                        // 如果启用微信二维码，设置为只读并使用二维码识别的内容
                        targetInput.readOnly = true;
                        if (decodedText) {
                            targetInput.value = decodedText;
                        }
                    } else {
                        // 如果禁用微信二维码，恢复可编辑状态
                        targetInput.readOnly = false;
                    }
                });
                
                // 初始禁用微信二维码开关
                document.getElementById('newIsWechat').disabled = true;
            }

            // 添加全局错误处理
            function setupErrorHandling() {
                window.addEventListener('unhandledrejection', function (event) {
                    if (event.reason.status === 401) {
                        window.location.href = '/login';
                    }
                });
            }

            // 二维码上传和识别相关
            function setupQRUpload() {
                const uploadArea = document.getElementById('qr-upload-area');
                const fileInput = document.getElementById('qr-file');
                const copyBtn = document.getElementById('copy-btn');
                const qrResult = document.getElementById('qr-result');

                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadArea.classList.add('bg-base-200');
                });
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadArea.classList.remove('bg-base-200');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    uploadArea.classList.remove('bg-base-200');
                    handleFiles(e.dataTransfer.files);
                });

                fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
                copyBtn.addEventListener('click', copyDecodedText);
            }

            function handleFiles(files) {
                if (files.length === 0) return;

                const file = files[0];
                if (!file.type.startsWith('image/')) {
                    showAlert('请上传图片文件');
                    return;
                }

                // 清除之前的二维码数据
                document.getElementById('qrCodeData').value = '';
                document.getElementById('qr-result').classList.add('hidden');
                document.getElementById('decoded-text').textContent = '';
                document.getElementById('newTarget').value = '';
                
                // 重置并禁用微信二维码开关
                const wechatToggle = document.getElementById('newIsWechat');
                wechatToggle.checked = false;
                wechatToggle.disabled = true;
                // 恢复目标URL输入框的可编辑状态
                document.getElementById('newTarget').readOnly = false;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        decodeQR(img);
                        // 保存原始二维码数据用于微信二维码
                        document.getElementById('qrCodeData').value = e.target.result;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            async function decodeQR(img) {
                try {
                    const codeReader = new ZXing.BrowserMultiFormatReader();
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // 调整画布大小，确保图像质量
                    const maxSize = 1024; // 限制最大尺寸
                    let width = img.naturalWidth;
                    let height = img.naturalHeight;

                    // 保持宽高比进行缩放
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = Math.floor(height * (maxSize / width));
                            width = maxSize;
                        } else {
                            width = Math.floor(width * (maxSize / height));
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;

                    // 使用更好的图像渲染设置
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';

                    // 绘制图像
                    ctx.drawImage(img, 0, 0, width, height);

                    // 尝试增强对比度
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const data = imageData.data;

                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        const threshold = 128;

                        // 二值化处理
                        const value = avg > threshold ? 255 : 0;
                        data[i] = data[i + 1] = data[i + 2] = value;
                    }

                    ctx.putImageData(imageData, 0, 0);

                    // 创建新的 Blob 并进行解码
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 1.0));
                    const imageUrl = URL.createObjectURL(blob);

                    try {
                        const result = await codeReader.decodeFromImageUrl(imageUrl);
                        URL.revokeObjectURL(imageUrl);

                        if (result) {
                            const decodedText = result.text;
                            document.getElementById('decoded-text').textContent = decodedText;
                            document.getElementById('qr-result').classList.remove('hidden');

                            // 自动填充到目标 URL 输入框
                            document.getElementById('newTarget').value = decodedText;
                            // 启用微信二维码开关
                            const wechatToggle = document.getElementById('newIsWechat');
                            wechatToggle.disabled = false;
                            // 如果是微信链接，自动启用微信二维码开关
                            if (decodedText.startsWith('https://weixin.qq.com/')) {
                                wechatToggle.checked = true;
                                // 设置目标URL为只读
                                document.getElementById('newTarget').readOnly = true;
                            }
                            showAlert('二维码识别成功', 'success');
                        }
                    } catch (decodeError) {
                        // 如果第一次识别失败，尝试不同的图像处理方式
                        try {
                            // 重置画布
                            ctx.clearRect(0, 0, width, height);
                            ctx.drawImage(img, 0, 0, width, height);

                            // 尝试反转颜色
                            const imageData = ctx.getImageData(0, 0, width, height);
                            const data = imageData.data;
                            for (let i = 0; i < data.length; i += 4) {
                                data[i] = 255 - data[i];         // 红
                                data[i + 1] = 255 - data[i + 1]; // 绿
                                data[i + 2] = 255 - data[i + 2]; // 蓝
                            }
                            ctx.putImageData(imageData, 0, 0);

                            const newBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 1.0));
                            const newImageUrl = URL.createObjectURL(newBlob);

                            const result = await codeReader.decodeFromImageUrl(newImageUrl);
                            URL.revokeObjectURL(newImageUrl);

                            if (result) {
                                const decodedText = result.text;
                                document.getElementById('decoded-text').textContent = decodedText;
                                document.getElementById('qr-result').classList.remove('hidden');
                                document.getElementById('newTarget').value = decodedText;
                                // 启用微信二维码开关
                                const wechatToggle = document.getElementById('newIsWechat');
                                wechatToggle.disabled = false;
                                // 如果是微信链接，自动启用微信二维码开关
                                if (decodedText.startsWith('https://weixin.qq.com/')) {
                                    wechatToggle.checked = true;
                                    // 设置目标URL为只读
                                    document.getElementById('newTarget').readOnly = true;
                                }
                                showAlert('二维码识别成功', 'success');
                            }
                        } catch (finalError) {
                            console.error('二维码识别错误:', finalError);
                            showAlert('无法识别二维码，请确保图片清晰且包含有效的二维码');
                            document.getElementById('qr-result').classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.error('图像处理错误:', error);
                    showAlert('处理图片时出错，请重试');
                    document.getElementById('qr-result').classList.add('hidden');
                }
            }

            function copyDecodedText() {
                const text = document.getElementById('decoded-text').textContent;
                navigator.clipboard.writeText(text)
                    .then(() => {
                        // 复制成功后自动填充到目标 URL 输入框
                        document.getElementById('newTarget').value = text;
                        // 滚动到添加短链二维码区域
                        document.getElementById('addNewRow').scrollIntoView({ behavior: 'smooth' });
                        showAlert('复制成功', 'success');
                    })
                    .catch(err => {
                        console.error('复制失败:', err);
                        showAlert('复制失败，请手动复制');
                    });
            }

            // 修改 showAlert 函数，支持更多类型
            function showAlert(message, type = 'error') {
                const alertContainer = document.getElementById('alertContainer');
                const alert = document.createElement('div');

                const alertClass = type === 'error' ? 'alert alert-error' : 'alert alert-success';
                alert.className = `${alertClass} mb-4 shadow-lg min-w-[300px]`;

                alert.innerHTML = `
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="${type === 'error'
                        ? 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z'
                        : 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'}"/>
                        </svg>
                        <span>${message}</span>
                    </div>
                `;

                alert.style.opacity = '0';
                alertContainer.appendChild(alert);

                setTimeout(() => {
                    alert.style.transition = 'opacity 0.3s ease-in-out';
                    alert.style.opacity = '1';
                }, 10);

                setTimeout(() => {
                    alert.style.opacity = '0';
                    setTimeout(() => alert.remove(), 300);
                }, 3000);
            }

            async function loadMappings() {
                const tableBody = document.getElementById('mappingsTableBody');
                const skeleton = document.getElementById('skeleton');

                // 显示骨架屏，隐藏表格内容
                tableBody.style.display = 'none';
                skeleton.classList.remove('hidden');

                try {
                    const response = await fetch(`/api/mappings?page=${currentPage}&pageSize=${pageSize}`);

                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    if (!response.ok) {
                        throw new Error('加载数据失败');
                    }

                    const data = await response.json();
                    allMappings = Object.entries(data.mappings);
                    
                    // 等待一小段时间再更新DOM
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // 更新表格内容
                    renderCurrentPage();

                    // 更新分页信息
                    currentPage = data.page;
                    const totalPages = data.totalPages;
                    document.getElementById('currentPage').textContent = currentPage;
                    document.getElementById('prevPage').disabled = currentPage <= 1;
                    document.getElementById('nextPage').disabled = currentPage >= totalPages;

                    // 设置页面大小选择器的当前值
                    document.getElementById('pageSize').value = pageSize;

                } catch (error) {
                    console.error('加载数据失败:', error);
                    showAlert('加载数据失败，请刷新页面重试');
                } finally {
                    // 隐藏骨架屏，显示表格内容
                    skeleton.classList.add('hidden');
                    tableBody.style.display = '';
                }
            }

            function renderCurrentPage() {
                const table = document.getElementById('mappingsTableBody');
                // 清空现有内容
                table.innerHTML = '';

                const fragment = document.createDocumentFragment();

                // 直接遍历所有映射
                for (const [path, mapping] of allMappings) {
                    const row = createMappingRow(path, mapping);
                    fragment.appendChild(row);
                }

                table.appendChild(fragment);
            }

            async function addMapping() {
                const name = document.getElementById('newName').value.trim();
                const path = document.getElementById('newPath').value.trim();
                const target = document.getElementById('newTarget').value.trim();
                const expiry = document.getElementById('newExpiry').value;
                const enabled = document.getElementById('newEnabled').checked;
                const isWechat = document.getElementById('newIsWechat').checked;
                const qrCodeData = document.getElementById('qrCodeData').value;

                // 输入验证
                if (!name) {
                    showAlert('请输入条目名称');
                    return;
                }
                if (!path) {
                    showAlert('请输入短链名');
                    return;
                }
                if (!/^[a-zA-Z0-9-_]+$/.test(path)) {
                    showAlert('短链名只能包含字母、数字、下划线和横线');
                    return;
                }
                if (!target) {
                    showAlert('请输入目标 URL');
                    return;
                }
                if (isWechat && !qrCodeData) {
                    showAlert('请先上传微信群二维码');
                    return;
                }

                try {
                    const response = await fetch('/api/mapping', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            name, 
                            path, 
                            target, 
                            expiry,
                            enabled,
                            isWechat,
                            qrCodeData: isWechat ? qrCodeData : null
                        })
                    });

                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    if (!response.ok) {
                        const data = await response.json();
                        showAlert(data.message || data.error || '添加失败，请重试');
                        return;
                    }

                    showAlert('添加成功', 'success');
                    location.reload();
                } catch (error) {
                    console.error('添加短链二维码失败:', error);
                    showAlert('添加失败，请检查网络连接后重试');
                }
            }

            async function deleteMapping(path) {
                const modal = document.getElementById('delete-confirm-modal');
                const confirmBtn = document.getElementById('confirm-delete-btn');

                // 创建一个 Promise 来处理用户的选择
                return new Promise((resolve) => {
                    const handleConfirm = async () => {
                        try {
                            const response = await fetch('/api/mapping', {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ path })
                            });

                            if (response.status === 401) {
                                window.location.href = '/login';
                                return;
                            }

                            if (!response.ok) {
                                const data = await response.json();
                                showAlert(data.message || data.error || '删除失败，请重试');
                                return;
                            }

                            showAlert('删除成功', 'success');
                            
                            // 不再刷新整个页面，而是重新加载表格数据
                            await loadMappings();
                            
                            // 如果当前在过期或即将过期的视图中，重新加载相应的数据
                            const expiringBtn = document.getElementById('showExpiringBtn');
                            const expiredBtn = document.getElementById('showExpiredBtn');
                            
                            if (expiringBtn.classList.contains('btn-warning')) {
                                await loadExpiringMappings('expiring');
                            } else if (expiredBtn.classList.contains('btn-error')) {
                                await loadExpiringMappings('expired');
                            }

                            // 关闭模态框
                            modal.close();
                        } catch (error) {
                            console.error('删除失败:', error);
                            showAlert('删除失败，请检查网络连接后重试');
                        } finally {
                            // 清理事件监听器
                            confirmBtn.removeEventListener('click', handleConfirm);
                            resolve();
                        }
                    };

                    // 添加确认按钮的点击事件
                    confirmBtn.addEventListener('click', handleConfirm);

                    // 显示模态框
                    modal.showModal();
                });
            }

            // 修改生成二维码的函数
            function generateQRForMapping(url, newPath) {
                const modal = document.getElementById('qr-modal');
                const container = document.getElementById('qr-container');
                const downloadBtn = document.getElementById('qr-download');
                const urlInput = document.getElementById('qr-url');
                const showLogoCheckbox = document.getElementById('qr-show-logo');
                const dotsStyleSelect = document.getElementById('qr-dots-style');

                // 清空之前的内容
                container.innerHTML = '';

                // 设置 URL 文本
                urlInput.value = url;

                // 从 localStorage 获取保存的设置
                const savedShowLogo = localStorage.getItem('qr-show-logo');
                const savedDotsStyle = localStorage.getItem('qr-dots-style');
                
                // 应用保存的设置
                if (savedShowLogo !== null) {
                    showLogoCheckbox.checked = savedShowLogo === 'true';
                }
                if (savedDotsStyle) {
                    dotsStyleSelect.value = savedDotsStyle;
                }

                // 基础 QR 配置
                const getQRConfig = (showLogo, dotsType) => ({
                    width: 300,
                    height: 300,
                    type: 'canvas',
                    data: url,
                    dotsOptions: {
                        color: "#000000",
                        type: dotsType
                    },
                    cornersSquareOptions: {
                        type: 'rounded'
                    },
                    cornersDotOptions: {
                        type: 'rounded'
                    },
                    backgroundOptions: {
                        color: "#FFFFFF"
                    },
                    qrOptions: {
                        errorCorrectionLevel: 'H'
                    },
                    ...(showLogo ? {
                        image: "/wechat.svg",
                        imageOptions: {
                            hideBackgroundDots: true,
                            imageSize: 0.23,
                            margin: 5
                        }
                    } : {})
                });

                // 创建新的二维码
                let currentQRCode = new QRCodeStyling(getQRConfig(showLogoCheckbox.checked, dotsStyleSelect.value));
                currentQRCode.append(container);

                // 监听复选框和选择器变化
                const updateQRCode = () => {
                    container.classList.add('switching');

                    setTimeout(() => {
                        container.innerHTML = '';
                        currentQRCode = new QRCodeStyling(getQRConfig(showLogoCheckbox.checked, dotsStyleSelect.value));
                        currentQRCode.append(container);

                        // 保存设置到 localStorage
                        localStorage.setItem('qr-show-logo', showLogoCheckbox.checked);
                        localStorage.setItem('qr-dots-style', dotsStyleSelect.value);

                        requestAnimationFrame(() => {
                            container.classList.remove('switching');
                        });
                    }, 200);
                };

                showLogoCheckbox.onchange = updateQRCode;
                dotsStyleSelect.onchange = updateQRCode;

                // 更新下载按钮点击事件
                downloadBtn.onclick = () => {
                    const timestamp = new Date().toISOString()
                        .replace(/[:.]/g, '-')
                        .replace('T', '_')
                        .replace('Z', '');
                    const fileName = `qr-${newPath}-${timestamp}`;
                    currentQRCode.download({
                        name: fileName,
                        extension: 'png'
                    });
                };

                // 显示模态框
                modal.showModal();
            }

            // 修改创建短链二维码行的函数中的二维码按钮部分
            function createMappingRow(path, mapping) {
                const row = document.createElement('tr');
                
                // 保存完整的原始数据到 row 的 dataset
                row.dataset.originalData = JSON.stringify({
                    name: mapping.name || '',
                    path: path,
                    target: mapping.target,
                    expiry: mapping.expiry || '',
                    enabled: mapping.enabled,
                    isWechat: mapping.isWechat,
                    qrCodeData: mapping.qrCodeData
                });

                // 使用数组和 map 来优化单元格创建
                const cellsData = [
                    { text: mapping.name || '-', data: mapping.name || '-' },
                    { text: path, data: path },
                    { text: mapping.target, data: mapping.target },
                    { text: mapping.expiry || '永久有效', data: mapping.expiry || '' }
                ];

                cellsData.forEach(({ text, data }, index) => {
                    const cell = document.createElement('td');
                    if (index === 2) { // 目标URL单元格
                        cell.classList.add('whitespace-normal', 'break-words', 'max-w-xs');
                        cell.style.wordBreak = 'break-all';
                        cell.style.minWidth = '200px';
                    }
                    cell.textContent = text;
                    cell.dataset.original = data;
                    row.appendChild(cell);
                });

                // 添加状态列
                const statusCell = document.createElement('td');
                statusCell.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="badge ${mapping.enabled ? 'badge-success' : 'badge-error'}">
                            ${mapping.enabled ? '启用' : '禁用'}
                        </span>
                        ${mapping.isWechat ? '<span class="badge badge-info">微信</span>' : ''}
                    </div>
                `;
                row.appendChild(statusCell);

                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <div class="join">
                        <button class="join-item btn btn-warning btn-sm">编辑</button>
                        <button class="join-item btn btn-error btn-sm">删除</button>
                        <button class="join-item btn btn-info btn-sm">二维码</button>
                    </div>
                `;

                // 添加事件监听器
                const [editBtn, deleteBtn, qrBtn] = actionsCell.querySelectorAll('button');
                editBtn.onclick = () => toggleEditMode(row);
                deleteBtn.onclick = (e) => {
                    e.preventDefault();
                    deleteMapping(path);
                };
                qrBtn.onclick = () => generateQRForMapping(window.location.origin + '/' + path, path);

                row.appendChild(actionsCell);
                return row;
            }

            // 添加切换编辑模式的函数
            async function toggleEditMode(row) {
                const isEditing = row.classList.toggle('editing');
                const cells = row.cells;
                const originalData = JSON.parse(row.dataset.originalData);

                if (isEditing) {
                    try {
                        // 获取当前行的完整数据
                        const response = await fetch(`/api/mapping?path=${originalData.path}`);
                        if (!response.ok) {
                            throw new Error('获取数据失败');
                        }
                        const mappingData = await response.json();

                        // 切换到编辑模式
                        cells[0].innerHTML = `<input type="text" class="input input-bordered input-sm w-full" value="${mappingData.name || ''}">`;
                        cells[1].innerHTML = `<input type="text" class="input input-bordered input-sm w-full" value="${mappingData.path}">`;
                        cells[2].innerHTML = `<textarea class="textarea textarea-bordered textarea-sm w-full h-24" style="resize:none; word-break:break-all;">${mappingData.target}</textarea>`;
                        cells[3].innerHTML = `<input type="date" class="input input-bordered input-sm w-full" value="${mappingData.expiry || ''}">`;
                        
                        // 状态切换
                        cells[4].innerHTML = `
                            <div class="flex flex-col gap-2">
                                <label class="cursor-pointer label justify-start gap-2">
                                    <input type="checkbox" class="toggle toggle-primary toggle-sm" ${mappingData.enabled ? 'checked' : ''}>
                                    <span class="label-text">启用</span>
                                </label>
                                <label class="cursor-pointer label justify-start gap-2">
                                    <input type="checkbox" class="toggle toggle-primary toggle-sm" ${mappingData.isWechat ? 'checked' : ''}>
                                    <span class="label-text">微信</span>
                                </label>
                            </div>
                        `;

                        // 修改按钮组
                        const actionsCell = cells[5];
                        actionsCell.innerHTML = `
                            <div class="join">
                                <button class="join-item btn btn-success btn-sm">保存</button>
                                <button class="join-item btn btn-primary btn-sm">取消</button>
                                <button class="join-item btn btn-info btn-sm">二维码</button>
                            </div>
                        `;

                        // 重新绑定事件监听器
                        const [saveBtn, cancelBtn, qrBtn] = actionsCell.querySelectorAll('button');
                        saveBtn.onclick = () => saveEdit(row);
                        cancelBtn.onclick = () => restoreRow(row);
                        qrBtn.onclick = () => generateQRForMapping(window.location.origin + '/' + originalData.path, originalData.path);
                    } catch (error) {
                        console.error('获取数据失败:', error);
                        showAlert('获取数据失败，请重试');
                        row.classList.remove('editing');
                    }
                }
            }

            async function saveEdit(row) {
                const cells = row.cells;
                const rowOriginalData = JSON.parse(row.dataset.originalData);

                const newName = cells[0].querySelector('input').value;
                const newPath = cells[1].querySelector('input').value;
                const newTarget = cells[2].querySelector('textarea').value;
                const newExpiry = cells[3].querySelector('input').value;
                const enabledToggle = cells[4].querySelector('input[type="checkbox"]');
                const isWechatToggle = cells[4].querySelectorAll('input[type="checkbox"]')[1];
                const newEnabled = enabledToggle.checked;
                const newIsWechat = isWechatToggle ? isWechatToggle.checked : false;

                // 检查是否有任何修改
                const hasChanges =
                    newName !== rowOriginalData.name ||
                    newPath !== rowOriginalData.path ||
                    newTarget !== rowOriginalData.target ||
                    newExpiry !== rowOriginalData.expiry ||
                    newEnabled !== rowOriginalData.enabled ||
                    (isWechatToggle && newIsWechat !== rowOriginalData.isWechat);

                if (!hasChanges) {
                    restoreRow(row);
                    return;
                }

                try {
                    // 获取原有数据
                    const response = await fetch(`/api/mapping?path=${rowOriginalData.path}`);
                    if (!response.ok) {
                        throw new Error('获取原有数据失败');
                    }
                    const serverData = await response.json();

                    // 保存更改
                    const updateResponse = await fetch('/api/mapping', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            originalPath: rowOriginalData.path,
                            path: newPath,
                            target: newTarget,
                            name: newName,
                            expiry: newExpiry || null,
                            enabled: newEnabled,
                            isWechat: newIsWechat,
                            qrCodeData: serverData.qrCodeData // 使用服务器返回的原始二维码数据
                        })
                    });

                    if (!updateResponse.ok) {
                        const data = await updateResponse.json();
                        showAlert(data.message || data.error || '更新失败，请重试');
                        return;
                    }

                    showAlert('更新成功', 'success');
                    
                    // 不再刷新整个页面，而是重新加载表格数据
                    await loadMappings();
                    
                    // 如果当前在过期或即将过期的视图中，重新加载相应的数据
                    const expiringBtn = document.getElementById('showExpiringBtn');
                    const expiredBtn = document.getElementById('showExpiredBtn');
                    
                    if (expiringBtn.classList.contains('btn-warning')) {
                        await loadExpiringMappings('expiring');
                    } else if (expiredBtn.classList.contains('btn-error')) {
                        await loadExpiringMappings('expired');
                    }
                } catch (error) {
                    console.error('更新失败:', error);
                    showAlert('更新失败，请检查网络连接后重试');
                }
            }

            function restoreRow(row) {
                const cells = row.cells;
                const originalData = JSON.parse(row.dataset.originalData);

                // 恢复各个单元格的内容
                cells[0].textContent = originalData.name || '-';
                cells[1].textContent = originalData.path;
                cells[2].textContent = originalData.target;
                cells[3].textContent = originalData.expiry || '永久有效';

                // 恢复状态列
                cells[4].innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="badge ${originalData.enabled ? 'badge-success' : 'badge-error'}">
                            ${originalData.enabled ? '启用' : '禁用'}
                        </span>
                        ${originalData.isWechat ? '<span class="badge badge-info">微信</span>' : ''}
                    </div>
                `;

                // 恢复按钮组
                const actionsCell = cells[5];
                actionsCell.innerHTML = `
                    <div class="join">
                        <button class="join-item btn btn-warning btn-sm">编辑</button>
                        <button class="join-item btn btn-error btn-sm">删除</button>
                        <button class="join-item btn btn-info btn-sm">二维码</button>
                    </div>
                `;

                // 重新绑定事件监听器
                const [editBtn, deleteBtn, qrBtn] = actionsCell.querySelectorAll('button');
                editBtn.onclick = () => toggleEditMode(row);
                deleteBtn.onclick = () => deleteMapping(originalData.path);
                qrBtn.onclick = () => generateQRForMapping(window.location.origin + '/' + originalData.path, originalData.path);

                row.classList.remove('editing');
            }

            async function updateMapping(mapping) {
                try {
                    const response = await fetch('/api/mapping', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(mapping)
                    });

                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    if (!response.ok) {
                        const data = await response.json();
                        showAlert(data.message || data.error || '更新失败，请重试');
                        return;
                    }

                    showAlert('更新成功', 'success');
                    location.reload();
                } catch (error) {
                    console.error('更新短链二维码失败:', error);
                    showAlert('更新失败，请检查网络连接后重试');
                }
            }

            // 修改 toggleTheme 函数
            function toggleTheme() {
                const html = document.documentElement;
                const currentTheme = localStorage.getItem('theme') || 'system';
                let newTheme;

                // 循环切换：system -> light -> dark -> system
                switch (currentTheme) {
                    case 'system':
                        newTheme = 'light';
                        break;
                    case 'light':
                        newTheme = 'dark';
                        break;
                    case 'dark':
                        newTheme = 'system';
                        break;
                    default:
                        newTheme = 'system';
                }

                localStorage.setItem('theme', newTheme);

                // 设置实际主题
                if (newTheme === 'system') {
                    const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    html.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
                } else {
                    html.setAttribute('data-theme', newTheme);
                }

                updateThemeIcon(newTheme);
            }

            function updateThemeIcon(theme) {
                const iconPath = themeToggleBtn.querySelector('path');
                switch (theme) {
                    case 'system':
                        // 显示系统图标（电脑显示器）
                        iconPath.setAttribute('d', 'M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z');
                        break;
                    case 'dark':
                        // 显示月亮图标
                        iconPath.setAttribute('d', 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z');
                        break;
                    case 'light':
                        // 显示太阳图标
                        iconPath.setAttribute('d', 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z');
                        break;
                }
            }

            // 添加系统主题变化监听
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (localStorage.getItem('theme') === 'system') {
                    document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                }
            });

            // 初始化主题图标
            updateThemeIcon(localStorage.getItem('theme') || 'system');

            let allMappings = [];
            let currentPage = 1;
            let pageSize = 10;

            // 添加分页和每页显示数量的事件监听器
            document.getElementById('nextPage').addEventListener('click', async () => {
                const expiringBtn = document.getElementById('showExpiringBtn');
                const expiredBtn = document.getElementById('showExpiredBtn');
                
                currentPage++;
                
                if (expiringBtn.classList.contains('btn-warning')) {
                    await loadExpiringMappings('expiring');
                } else if (expiredBtn.classList.contains('btn-error')) {
                    await loadExpiringMappings('expired');
                } else {
                    await loadMappings();
                }
            });

            document.getElementById('prevPage').addEventListener('click', async () => {
                if (currentPage > 1) {
                    currentPage--;
                    const expiringBtn = document.getElementById('showExpiringBtn');
                    const expiredBtn = document.getElementById('showExpiredBtn');
                    
                    if (expiringBtn.classList.contains('btn-warning')) {
                        await loadExpiringMappings('expiring');
                    } else if (expiredBtn.classList.contains('btn-error')) {
                        await loadExpiringMappings('expired');
                    } else {
                        await loadMappings();
                    }
                }
            });

            document.getElementById('pageSize').addEventListener('change', async (e) => {
                pageSize = parseInt(e.target.value);
                currentPage = 1;
                
                // 根据当前视图状态重新加载数据
                const expiringBtn = document.getElementById('showExpiringBtn');
                const expiredBtn = document.getElementById('showExpiredBtn');
                
                if (expiringBtn.classList.contains('btn-warning')) {
                    await loadExpiringMappings('expiring');
                } else if (expiredBtn.classList.contains('btn-error')) {
                    await loadExpiringMappings('expired');
                } else {
                    await loadMappings();
                }
            });

            async function logout() {
                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (!response.ok) {
                        showAlert('登出失败，请重试');
                        return;
                    }

                    window.location.href = '/login';
                } catch (error) {
                    console.error('登出失败:', error);
                    showAlert('登出失败，请检查网络连接后重试');
                }
            }

            // 添加加载即将过期映射的函数
            async function loadExpiringMappings(type) {
                const tableBody = document.getElementById('mappingsTableBody');
                const skeleton = document.getElementById('skeleton');

                // 显示骨架屏，隐藏表格内容
                tableBody.style.display = 'none';
                skeleton.classList.remove('hidden');

                try {
                    const response = await fetch(`/api/expiring-mappings?page=${currentPage}&pageSize=${pageSize}`);

                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }

                    const data = await response.json();
                    
                    // 获取今天的日期（去除时间部分）
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // 根据类型和过期时间筛选数据
                    const mappingsArray = data[type];
                    
                    // 确保日期比较的准确性
                    mappingsArray.forEach(mapping => {
                        const expiryDate = new Date(mapping.expiry);
                        expiryDate.setHours(0, 0, 0, 0); // 只比较日期部分
                        mapping.isExpired = expiryDate < today;
                    });
                    
                    // 根据类型过滤数据
                    const filteredMappings = type === 'expired' 
                        ? mappingsArray.filter(m => m.isExpired)
                        : mappingsArray.filter(m => !m.isExpired);
                        
                    const total = filteredMappings.length;
                    
                    // 计算当前页的数据
                    const start = (currentPage - 1) * pageSize;
                    const end = Math.min(start + pageSize, total);
                    const currentPageData = filteredMappings.slice(start, end);
                    
                    // 清空表格
                    tableBody.innerHTML = '';
                    
                    // 渲染当前页数据
                    currentPageData.forEach(mapping => {
                        const row = createMappingRow(mapping.path, {
                            name: mapping.name,
                            target: mapping.target,
                            expiry: mapping.expiry,
                            enabled: mapping.enabled,
                            isWechat: mapping.isWechat,
                            qrCodeData: mapping.qrCodeData
                        });
                        tableBody.appendChild(row);
                    });

                    // 更新分页信息
                    const totalPages = Math.ceil(total / pageSize);
                    document.getElementById('currentPage').textContent = currentPage;
                    document.getElementById('prevPage').disabled = currentPage <= 1;
                    document.getElementById('nextPage').disabled = currentPage >= totalPages || total === 0;

                } catch (error) {
                    console.error('加载数据失败:', error);
                    showAlert('加载数据失败，请刷新页面重试');
                } finally {
                    skeleton.classList.add('hidden');
                    tableBody.style.display = '';
                }
            }

            // 在页面加载时初始化二维码设置
            document.addEventListener('DOMContentLoaded', function() {
                // 初始化二维码设置
                const savedShowLogo = localStorage.getItem('qr-show-logo');
                const savedDotsStyle = localStorage.getItem('qr-dots-style');
                
                // 设置显示logo复选框
                if (savedShowLogo !== null) {
                    document.getElementById('qr-show-logo').checked = savedShowLogo === 'true';
                }
                
                // 设置点样式下拉框
                if (savedDotsStyle) {
                    document.getElementById('qr-dots-style').value = savedDotsStyle;
                }
                
                // 添加设置变更监听器
                document.getElementById('qr-show-logo').addEventListener('change', function(e) {
                    localStorage.setItem('qr-show-logo', e.target.checked);
                    // 如果二维码已经显示，则更新二维码
                    if (qrCode) {
                        updateQRCode();
                    }
                });
                
                document.getElementById('qr-dots-style').addEventListener('change', function(e) {
                    localStorage.setItem('qr-dots-style', e.target.value);
                    // 如果二维码已经显示，则更新二维码
                    if (qrCode) {
                        updateQRCode();
                    }
                });
            });

            // 更新生成二维码的函数，使用保存的设置
            function updateQRCode() {
                const url = document.getElementById('qr-url').value;
                const showLogo = document.getElementById('qr-show-logo').checked;
                const dotsStyle = document.getElementById('qr-dots-style').value;
                
                const options = {
                    width: 240,
                    height: 240,
                    data: url,
                    margin: 10,
                    qrOptions: {
                        typeNumber: 0,
                        mode: 'Byte',
                        errorCorrectionLevel: 'H'
                    },
                    imageOptions: {
                        hideBackgroundDots: true,
                        imageSize: 0.4,
                        margin: 4
                    },
                    dotsOptions: {
                        type: dotsStyle,
                        color: '#000000'
                    },
                    backgroundOptions: {
                        color: '#ffffff'
                    }
                };

                if (showLogo) {
                    options.image = '/wechat.svg';
                }

                // 如果已经存在二维码实例，先移除旧的
                if (qrCode) {
                    const container = document.getElementById('qr-container');
                    container.classList.add('switching');
                    
                    setTimeout(() => {
                        qrCode.update(options);
                        container.classList.remove('switching');
                    }, 200);
                } else {
                    qrCode = new QRCodeStyling(options);
                    qrCode.append(document.getElementById('qr-container'));
                }
            }

        });
    </script>
</body>

</html>